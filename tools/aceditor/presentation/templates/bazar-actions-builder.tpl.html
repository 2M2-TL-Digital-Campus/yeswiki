<div class="modal" id="bazar-actions-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h2 class="modal-title"><?php echo _t('ACEDITOR_ACTIONS_BAZAR'); ?></h2>
      </div>

      <!-- Modal Body -->
      <div id="bazar-actions-builder-app" class="modal-body">
        <!-- Choose form -->
        <div class="form-group">
          <label class="control-label"><?php echo _t('ACTION_BUILDER_CHOOSE_FORM'); ?></label>
          <select v-model="selectedFormId" required class="form-control">
            <option v-for="(name, id) in formIds" :value="id">{{ name }}</option>
          </select>
        </div>

        <!-- Choose Bazar Action -->
        <div class="form-group">
          <label class="control-label"><?php echo _t('ACTION_BUILDER_CHOOSE_ACTION'); ?></label>
          <select v-model="selectedActionId" required class="form-control">
            <option v-for="(action, actionId) in actions" :value="actionId">{{ action.label }}</option>
          </select>
        </div>

        <!-- Action Parameters -->
        <div v-if="selectedAction" class="row" class="action-parameters-container">
          <div class="col-md-12">
            <div class="alert alert-info">{{ selectedAction.description }}</div>
          </div>

          <!-- Iframe Preview -->
          <div class="col-md-12 widget-iframe-container">
            <h3>Apperçu (non clickable)</h3>
            <iframe class="iframe-preview" width="100%" height="350px" frameborder="0" :src="previewIframeUrl"></iframe>
            <div class="iframe-blocker"></div>
          </div>

          <!-- Action Params -->
          <div class="col-md-3">
            <h3><?php echo _t('ACTION_BUILDER_PARAMETERS') ?></h3>
            <div class="form-group" :class="property.type" v-for="(property, propName)  in selectedAction.properties">
                <label v-if="property.label && property.type != 'checkbox'" class="control-label">{{ property.label }}</label>
                <!-- Text Property -->
                <template v-if="property.type == 'text'">
                  <input type="text" v-model="values[propName]" class="form-control" :required="property.required"/>
                </template>
                <!-- Number Property -->
                <template v-else-if="property.type == 'number'">
                  <input type="number" v-model="values[propName]" class="form-control" :required="property.required" :min="property.min" :max="property.max"/>
                </template>
                <!-- Color Property -->
                <template v-else-if="property.type == 'color'">
                  <input type="color" v-model="values[propName]" class="form-control" :required="property.required"/>
                </template>
                <!-- List Property -->
                <template v-else-if="property.type == 'list'">
                  <select class="form-control" v-model="values[propName]" :required="property.required">
                    <option value=""></option>
                    <option v-for="option in property.options" :value="option" >{{ option }}</option>
                  </select>
                </template>
                <!-- Checkbox Property -->
                <template v-else-if="property.type == 'checkbox'">
                  <label>
                    <input type="checkbox" v-model="values[propName]"/>
                    <span>{{ property.label }}</span>
                  </label>
                </template>
                <!-- Field Property -->
                <template v-else-if="property.type == 'form_field'">
                  <select v-model="values[propName]" class="form-control">
                    <option value=""></option>
                    <option v-for="field in selectedForm.prepared" v-if="field.label" :value="field.id">{{ field.label }} - {{ field.id }}</option>
                  </select>
                </template>
                <!-- Other Property -->
                <template v-else>
                  <input type="hidden" v-model="values[propName]" />
                </template>
            </div>
          </div>

          <!-- Filters Params -->
          <div class="col-md-4 filter-parameters-container">
            <h3>Filtres / Recherche</h3>
            <!-- Search -->
            <label>
              <input type="checkbox" v-model="values.search" />
              <span>Barre de recherche</span>
            </label>
            <!-- Pagination -->
            <div class="form-group">
              <label class="control-label">Nombre de fiches par page</label>
              <input type="number" v-model="values.pagination" class='form-control' />
            </div>
            <!-- Query -->
            <div class="form-group">
              <label class="control-label">Requête SQL (avancé)</label>
              <input type="text" v-model="values.query" class='form-control' />
            </div>
          </div>

          <div class="col-md-5">
            <h3>Facettes</h3>
            <!-- Facettes Config -->
            <div class="filter-group-form" v-if="selectedForm" v-for="filter in filterGroups">
              <div class="col-sm-4 form-group">
                <label class="control-label">Champ</label>
                <select v-model="filter.field" class="form-control">
                  <option v-for="field in selectedForm.prepared" v-if="field.label" :value="field.id">{{ field.label }} - {{ field.id }}</option>
                </select>
              </div>
              <div v-if="selectedForm" class="col-sm-4 form-group">
                <label class="control-label">Titre</label>
                <input type="text" v-model="filter.title" class="form-control" />
              </div>
              <div v-if="selectedForm" class="col-sm-3 form-group">
                <label class="control-label">Icone </label>
                <input type="text" v-model="filter.icon" class="form-control" />
              </div>
              <div class="form-group col-sm-1">
                <button class="btn btn-default btn-icon" @click="removeFilterGroup(filter)">
                  <i class="btn-remove-group fa fa-times"></i>
                </button>
              </div>
            </div>
            <!-- Add Facette -->
            <button v-if="selectedForm" @click="addEmptyFilterGroup" class="btn btn-info btn-add-group">Ajouter une Facette</button>
            <hr />

            <!-- Facette display -->
            <div class="form-group">
              <label class="control-label">Affichage initial des facettes</label>
              <select v-model="values.groupsexpanded" class="form-control">
                  <option value=""></option>
                  <option value="0">Non dépliées</option>
                  <option value="1">Dépliées</option>
              </select>
            </div>
            <div class="form-group">
              <label class="control-label">Position des facettes</label>
              <select v-model="values.filterposition" class="form-control">
                  <option value=""></option>
                  <option value="right">Droite</option>
                  <option value="left">Gauche</option>
              </select>
            </div>
            <div class="form-group">
              <label class="control-label">Largeur des facettes (1 à 12)</label>
              <input type="number" min="1" max="12" v-model="values.filtercolsize" class="form-control"/>
            </div>
            <hr />
            
            <!-- Icons -->
            <div class="form-group" v-if="selectedForm">
              <label class="control-label">Champ pour la couleur</label>
              <select v-model="values.iconfield" class="form-control">
                <option value=""></option>
                <option v-for="field in selectedForm.prepared.filter(a => typeof a.values == 'object')" :value="field.id">{{ field.id }}</option>
              </select>
            </div>
            <div class="filter-group-form" v-if="values.iconfield" v-for="mapping in iconMapping">
              <div class="col-sm-6 form-group">
                <label class="control-label">Valeur</label>
                <select v-model="mapping.id" class="form-control">
                  <option v-for="(optionName, optionId) in iconOptions" :value="optionId">{{ optionName }}</option>
                </select>
              </div>
              <div class="col-sm-5 form-group">
                <label class="control-label">Icone</label>
                <input type="text" v-model="mapping.icon" class="form-control" />
              </div>
              <div class="form-group col-sm-1">
                <button class="btn btn-default btn-icon" @click="removeIconMapping(mapping)">
                  <i class="btn-remove-group fa fa-times"></i>
                </button>
              </div>
            </div>
            <button v-if="values.iconfield" @click="addEmptyIconMapping" class="btn btn-info btn-icon btn-add-group">
              <i class="fa fa-plus"></i>
            </button>
            <hr />
          </div>

          <div class="col-md-12 result-container">
            <h3><?php echo _t('ACTION_BUILDER_WIKI_CODE_TITLE') ?></h3>
            <div class="input-group">
              <div class="input-group-addon btn btn-primary" @click="insertCodeInEditor">
                {{ isEditingExistingAction ? 'Mettre à jour le code' : 'Insérer dans la page' }}
              </div>
              <input type="text" class="result form-control" @click="selectFullText" :value="wikiCode" ref="wikiCode">
              <div class="input-group-addon btn btn-default" @click="copyContent"><?php echo _t('ACTION_BUILDER_COPY') ?></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-block" data-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<script>
  // Not very elegant, but avoid doing an ajax request from vue component to retrieve the Json data
  var data = <?php echo json_encode($data) ?>;
</script>

<?php
  // $GLOBALS['wiki']->addJavascriptFile('libs/vue.min.js');
  $GLOBALS['wiki']->addJavascriptFile('libs/vue.js'); // For dev only
  $GLOBALS['wiki']->addJavascriptFile('tools/aceditor/presentation/javascripts/bazar-actions-builder.js');
  $GLOBALS['wiki']->addCSSFile('tools/aceditor/presentation/styles/bazar-actions-builder.css');
?>
