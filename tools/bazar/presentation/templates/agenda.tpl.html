
<?php if( count($fiches)>0 ) : ?>
<?php
$imgwidth=450;
$imgheight=450;
$classnb = 1;
$agenda = 'tout';
$datejour = time();
$rowcol = ''; // declaration d'une chaine de char vide
$modal = ''; // declaration d'une chaine de char vide
?>
<!-- traces : pour avoir date en mois : <?php echo str_replace('00:00', '', date("M", strtotime($fiche['bf_date_debut_evenement']))); ?> -->

<?php
/**************************************************************************************************
 * parametres du template :
 * ils peuvent être passés dans l'action bazar ou bazarliste, mais sont spécifiques à ce template
 **************************************************************************************************/

 // test si on veut affichage de toutes les activités (tout) (par défaut) ou seulement celles à venir (futur)
 $agenda = $GLOBALS['wiki']->GetParameter('agenda');
 if (empty($agenda)) {
     $agenda = 'tout';
 }

 if ($agenda=='futur') {

      if (!function_exists('date_periode')) {
       function date_periode($fiche) {
          $nbjour = 290;
          $datejour = time();
          $datemax = $datejour + ($nbjour*24*60*60);  // date max � J+ nb de jours
          $datefiche = strtotime($fiche['bf_date_debut_evenement']);
        $datefin = strtotime($fiche['bf_date_fin_evenement']);
          if (($datefiche >=$datejour  && $datefiche <=$datemax ) || ($datefin >=$datejour  && $datefin <=$datemax )) {
              return true;
              }
           else  {
               return  false;
          }
      }
      }
      if (!function_exists('date_compare')) {
          //tri par ordre chronologique
           function date_compare($a, $b)
           {
             $t1 = strtotime($a['bf_date_debut_evenement']);    // strtotime = fonction qui transforme une chaine de caractere en date informatque (= un chiffre calcul� depuis 1970)
             $t2 = strtotime($b['bf_date_debut_evenement']);
           return $t1 - $t2;
         }
      }
        $fiches = array_filter($fiches, "date_periode");
        usort($fiches, 'date_compare');  // http://php.net/manual/fr/function.usort.php (si on veut avoir mal au crane)
 }
?>



<div class="agenda-container">
  <?php foreach($fiches as $fiche): ?>
  <div class="agenda-entry-container">
    <figure class="bazar-entry agenda-entry" <?php echo $fiche['html_data'];?>>
      <div class="image">
        <?php if (isset($fiche['imagebf_image']) && $fiche['imagebf_image']!='') : ?>
          <img class="img-responsive" alt="<?php echo htmlspecialchars($fiche['bf_titre']);?>" src="<?php echo redimensionner_image('files/'.$fiche['imagebf_image'], 'cache/image_'.$imgwidth.'x'.$imgheight.'_'.$fiche['imagebf_image'], $imgwidth, $imgheight, 'crop'); ?>">
        <?php else : ?>
          <img class="trombi-image img-placeholder"
               src="tools/bazar/libs/vendor/placeholder.php?size=300x300&amp;bg=efefef&amp;text=">
          <i class="trombi-image icon-placeholder fa fa-calendar"></i>
        <?php endif; ?>
      </div>
      <fig-caption>
        <?php $moisen = date("M", strtotime($fiche['bf_date_debut_evenement'])); ?>
        <?php  $moisfr = str_replace(array('Feb', 'Apr', 'May', 'Jun', 'Aug') , array('fev', 'avr', 'mai', 'jui', 'aou'), $moisen); ?>

        <div class="date"><span class="day"><?php echo substr($fiche['bf_date_debut_evenement'],8,2); ?></span><span class="month"><?php echo $moisfr;?></span></div>
        <h5><?php echo $fiche['bf_titre'];?></h5>
        <?php if (isset($fiche['soustitre']) && !empty($fiche['soustitre'])) :
          $soustitre = nl2br(strip_tags($GLOBALS['wiki']->format($fiche['soustitre']), '<br>')); ?>
            <small class='agenda-subtitle'>
              <?php echo substr($soustitre, 0, 280) . (strlen($soustitre) > 280 ? '...' : ''); ?>
            </small>
        <?php endif; ?>

        </p>
      </fig-caption>
      <?php $useModal = $GLOBALS['wiki']->GetParameter('modal') == 1; ?>
      <a class="<?php echo $useModal ? 'modalbox' : ''; ?>"
         title="<?php echo htmlspecialchars($fiche['bf_titre']);?>"
         href="<?php echo $GLOBALS['wiki']->href('', $fiche['id_fiche']); ?>">
      </a>
    </figure>
  </div>
  <?php endforeach; ?>
</div> <!-- /.row --><!-- permet de fermer la class row si jamais y a que 3 images -->
<style>
.agenda-container {
  display: flex;
  flex-wrap: wrap;
  margin-left: -1rem;
  margin-right: -1rem;
}
<?php
 // Nombres de colonne
 $nbcol = $GLOBALS['wiki']->GetParameter('nbcol');
 $width = empty($nbcol) ? 20 : 100 / $nbcol;
 $width1200 = empty($nbcol) ? 25 : max([$width, 25]);
?>
.agenda-entry-container {
  width: <?php echo $width; ?>%;
  padding: 1rem;
}
@media (max-width: 1200px) { .agenda-entry-container { width: <?php echo $width1200; ?>%; } }
@media (max-width: 900px) { .agenda-entry-container { width: 33%; } }
@media (max-width: 700px) { .agenda-entry-container { width: 50%; } }

.agenda-entry {
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.15);
  color: #ffffff;
  float: left;
  font-size: 16px;
  overflow: hidden;
  position: relative;
  text-align: left;
  height: 100%;
  width: 100%;
  background-color: #efefef;
}

.agenda-entry img {
  max-width: 100%;
  vertical-align: top;
  position: relative;
  transition: transform 0.2s;
}

.agenda-entry fig-caption {
  padding: 25px 20px 25px;
  position: absolute;
  bottom: 0;
  z-index: 1;
  width: 100%;
}

.agenda-entry fig-caption:before {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background: #700877;
  content: '';
  background: -moz-linear-gradient(90deg, #700877 0%, #ff2759 100%, #ff2759 100%);
  background: -webkit-linear-gradient(90deg, #700877 0%, #ff2759 100%, #ff2759 100%);
  background: linear-gradient(90deg, #700877 0%, #ff2759 100%, #ff2759 100%);
  opacity: 0.8 !important;
  z-index: -1;
}

.agenda-entry fig-caption h5 {
  color: white;
}

.agenda-entry .date {
  background-color: #fff;
  border-radius: 50%;
  color: #700877;
  font-size: 18px;
  font-weight: 700;
  min-height: 48px;
  min-width: 48px;
  padding: 10px 0;
  position: absolute;
  right: 15px;
  text-align: center;
  text-transform: uppercase;
  top: -25px;
}

.agenda-entry .date span {
  display: block;
  line-height: 14px;
}

.agenda-entry .date .month {
  font-size: 11px;
}

.agenda-entry h3,
.agenda-entry h5,
.agenda-entry p {
  margin: 0;
  padding: 0;
}

.agenda-entry h3 {
  display: inline-block;
  font-weight: 700;
  letter-spacing: -0.4px;
  margin-bottom: 5px;
}

.agenda-entry h5 {
  display: inline-block;
  font-weight: 500;
  letter-spacing: -0.4px;
  margin-bottom: 5px;
}

.agenda-entry p {
  font-size: 0.8em;
  line-height: 1.6em;
  margin-bottom: 0px;
}

.agenda-entry a {
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  position: absolute;
  z-index: 1;
}

.agenda-entry:hover img,
.agenda-entry.hover img {
  transform: scale(1.1);
}

</style>
<?php endif; ?>
